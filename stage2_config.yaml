# Stage 2 Configuration: Manual Annotations Fine-tuning
# Fine-tuning config for high-quality manual annotations
# 
# STAGE 2 DATASET: 7 images with high-quality manual annotations  
# - Training: 1400 iterations for precise fine-tuning (200 epochs × 7 images)
# - Optimized learning rate for effective adaptation to manual annotations
# - Loads weights from Stage 1 checkpoint

_BASE_: configs/coco/instance-segmentation/swin/maskformer2_swin_base_384_bs16_50ep.yaml

# Model configuration
MODEL:
  # Will be set dynamically to Stage 1 checkpoint
  WEIGHTS: ""  # Set by training script to stage1 checkpoint
  
  SEM_SEG_HEAD:
    # Single class: myotube  
    NUM_CLASSES: 1
  
  # Fine-tuned settings for precise manual annotations
  MASK_FORMER:
    TEST:
      OBJECT_MASK_THRESHOLD: 0.4  # Higher threshold for quality manual annotations
      OVERLAP_THRESHOLD: 0.0  # Zero overlap - each myotube is completely distinct

# Dataset configuration for Stage 2 (manual annotations)
DATASETS:
  TRAIN: ("myotube_stage2_train",)
  TEST: ("myotube_stage2_val",)

# Stage 2 Solver: Fine-tuning settings for manual annotations (7 images)
SOLVER:
  IMS_PER_BATCH: 1  # Single image batch (optimized for memory)
  BASE_LR: 0.00005  # Conservative LR for 7 images (more stable training)
  MAX_ITER: 1400    # For 7 images: ~200 epochs (7 images × 200 = 1400 iter)
  STEPS: (980, 1260) # LR drops at 70% and 90% of 1400 iterations
  WARMUP_FACTOR: 0.1
  WARMUP_ITERS: 70  # Proportional warmup for longer training
  WEIGHT_DECAY: 0.01  # Reduced weight decay for fine-tuning
  OPTIMIZER: "ADAMW"
  BACKBONE_MULTIPLIER: 0.03  # Very conservative backbone for precise tuning
  CLIP_GRADIENTS:
    ENABLED: True
    CLIP_TYPE: "full_model"
    CLIP_VALUE: 0.003  # Very small gradient clipping for precise tuning
    NORM_TYPE: 2.0
  AMP:
    ENABLED: True

# Input configuration optimized for manual annotations
INPUT:
  IMAGE_SIZE: 1500  # Match original resolution for precise manual annotations
  MIN_SCALE: 0.9    # Very conservative scaling for precise manual boundaries
  MAX_SCALE: 1.1    # Minimal scaling to preserve manual annotation precision
  FORMAT: "RGB"
  DATASET_MAPPER_NAME: "coco_instance_lsj"
  
  # Enhanced but careful augmentations for manual annotations
  CROP:
    ENABLED: True
    TYPE: "relative_range"
    SIZE: [0.15, 0.25]  # Moderate cropping while preserving myotube connectivity
  
  # Mild color augmentation to preserve manual annotation integrity
  COLOR_AUG_SSD: True
  
  # All orientations (myotubes in all directions in the image)
  RANDOM_FLIP: "horizontal"

# Evaluation configuration  
TEST:
  EVAL_PERIOD: 140  # Evaluate every 20 epochs (7 images × 20 = 140 iterations)

# Data loader configuration
DATALOADER:
  FILTER_EMPTY_ANNOTATIONS: True
  NUM_WORKERS: 1  # Single worker for high-res images to avoid memory issues

# Output directory for Stage 2
OUTPUT_DIR: "./output_stage2_manual"

VERSION: 2 